<!doctype html>
<html lang="pt-br">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>PHP fora da Web</title>

        <link href="https://fonts.googleapis.com/css?family=Fira+Sans:100,100i,300,300i,400,400i,700,700i%7CRaleway:200,300,400,600,700&amp;subset=latin-ext" rel="stylesheet">

        <link rel="stylesheet" type="text/css" media="all" href="static/css/webslides.css">
        <link rel="stylesheet" type="text/css" media="all" href="static/css/prism.css">
        <link rel="stylesheet" type="text/css" media="all" href="static/css/styles.css">
        <link rel="stylesheet" type="text/css" media="all" href="static/css/svg-icons.css">
    </head>
    <body>
        <main role="main">
            <article id="webslides">
                <section>
                    <div class="wrap aligncenter">
                        <h1><strong>PHP fora da Web</strong></h1>
                        <p class="text-intro">Utilizando nossa linguagem preferida <span class="red">&hearts;</span> para criar CLI scripts e robôs</p>
                    </div>
                </section>
                <section>
                    <div class="wrap size-50 aligncenter">
                        <h2><strong>Roteiro</strong></h2>
                        <div class="bg-white shadow">
                            <ul class="flexblock reasons">
                                <li>
                                    <h3>Scripts CLI</h3>
                                    <p>Lidando com argumentos, streams e roteamento de comandos</p>
                                </li>
                                <li>
                                    <h3>Robôs</h3>
                                    <p>Gerenciando início e término de robôs, usando <code>pcntl</code> ou <code>pthreads</code></p>
                                </li>
                                <li>
                                    <h3>Reutilização</h3>
                                    <p>Criando códigos que rodem em mais de um ambiente</p>
                                </li>
                            </ul>
                        </div>
                    </div>
                </section>
                <section>
                    <div class="aligncenter">
                        <h2><strong>Scripts CLI</strong></h2>
                        <p>Criando utilitários para a linha de comando</p>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <div class="grid vertical-align">
                            <div class="column">
                                <h3>Argumentos</h3>
                                <p class="text-intro">As variáveis <code>$argc</code> e <code>$argv</code> guardam informações sobre os argumentos do script</p>
                                <p><code>$argv</code> é um <em>array</em> com os argumentos passados, sendo que o índice 0 contém o nome do script invocado</p>
                            </div>
                            <div class="column">
                                <pre><code class="language-php">if ($argc == 1) {
    echo "Uso: php {$argv[0]} &lt;comando&gt;" . PHP_EOL;
    exit(2);
}
switch ($argv[1]) {
    case 'run':
        // ...
        break;

    default:
        // ...
        break;
}</code></pre>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <div class="grid vertical-align">
                            <div class="padded-sides width-100">
                                <h4>getopt()</h4>
                                <p class="text-intro"><code class="language-php">array getopt( string $options [, array $longopts [, int &amp;$optind ]] )</code></p>
                            </div>
                            <div class="column">
                                <p class="no-margin-bottom">As opções podem ser:</p>
                                <ul class="squared no-margin-top">
                                    <li>Caracteres individuais: não aceitam valores</li>
                                    <li>Caracteres seguidos por um dois-pontos: valor obrigatório</li>
                                    <li>Caracteres seguidos por dois dois-pontos: valor opcional</li>
                                </ul>
                                <pre><code class="language-php">$options = getopt(
    'ab:c::',
    ['verbose', 'user:', 'password::']
);
</code></pre>
                            </div>
                            <div class="column">
                                <pre><code class="language-php">// php getopt.php -a -b valor -c1 --verbose \
//  --user root --password
array(6) {
  ["a"]        => bool(false)
  ["b"]        => string(5) "valor"
  ["c"]        => string(1) "1"
  ["verbose"]  => bool(false)
  ["user"]     => string(4) "root"
  ["password"] => bool(false)
}
</code></pre>

                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <div class="grid vertical-align">
                            <div class="column">
                                <h3>Streams</h3>
                                <p class="text-intro">Uso básico das funções <code>fopen</code>, <code>fgets</code> e <code>fputs</code></p>
                                <p>Junto com as constantes <code>STDIN</code>, <code>STDOUT</code> e <code>STDERR</code></p>
                            </div>
                            <div class="column">
                                <pre><code class="language-php">echo "Qual seu nome? ";
$line = trim(fgets(STDIN));
echo "Bem-vindo, {$line}." . PHP_EOL;
</code></pre>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <h3>Mais streams</h3>
                        <p class="text-intro">Uso de funções como <code>stream_context_create</code>, <code>stream_copy_to_stream</code>, <code>stream_filter_append</code>, entre outras</p>
                        <div class="panel">
                            Referências
                            <ul>
                                <li>Manual do PHP: <a href="http://php.net/stream">php.net/stream</a></li>
                                <li>Palestra do Alexandre Gaigalas na PHP Experience em 2016: <a href="https://www.youtube.com/watch?v=ZRYMzS97HVQ">PHP Streams</a></li>
                            </ul>
                        </div>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <div class="grid vertical-align">
                            <div class="column">
                                <h3>Roteamento de comandos</h3>
                                <p class="text-intro">Organize seu script para que ele seja modular</p>
                                <p>
                                    Para organizar melhor seu script, você pode estruturá-lo usando MVC, por exemplo.<br>>
                                    Crie estrutura de controllers e/ou actions e seu código irá ficar mais enxuto.
                                </p>
                            </div>
                            <div class="column">
                                <pre><code class="language-php">if ($argc != 3) {
    echo "Uso: {$argv[0]} <module> <command>" . PHP_EOL;
    exit(2);
}

include 'vendor/autoload.php';
array_shift($argv); // nome do script

$module = array_shift($argv); // ou $options['module']
$class = "MyCli\Controllers\\{$module}";
if (!class_exists($class)) {
    throw new DomainException("Módulo {$module} não encontrado");
}

$command = array_shift($argv); // ou $options['command']
if (!method_exists($class, $command)) {
    throw new DomainException("Comando {$command} não encontrado");
}

(new $class())->{$command}($argv); // ou $options
</code></pre>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <div class="grid vertical-align">
                            <div class="column">
                                <h3>Bibliotecas</h3>
                            </div>
                            <div class="column">
                                <ul>
                                    <li>Zend\Console</li>
                                    <li>Symfony Console</li>
                                    <li>Laravel Zero</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>
<!--
                    Robôs
    pcntl
        Sinais
            pcntl_signal() para instalar o handler de sinais
            pcntl_signal_dispatch() para despachar sinais pendentes
            posix_kill() para enviar um sinal
    Biblioteca pthreads
        Introdução
            v3 e a rescrita no PHP 7.2
            Instalação no PHP 7.2
            Referências
                https://www.sitepoint.com/upgrading-pthreads-v2-v3-look/
                https://www.sitepoint.com/parallel-programming-pthreads-php-fundamentals/
        Classes
            Threaded
            Thread
            Stackable
            Worker
            Pool
    Reutilização
        Como criar códigos que rodem em qualquer ambiente?
        Performance
        Boas práticas
            Legibilidade de código: PHPCS, PHPMD
            SOLID
            Object Calisthenics
        Configurações
            Através de variáveis de ambiente
            Recomendação “12 Factor Apps”: https://www.12factor.net/config
        Injeção de dependências
            Interfaces
                Dependendo de Interfaces ao invés de classes Concretas ou até mesmo Abstratas
            Containers
                PSR-11: https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-11-container.md
                The PHP League Container: https://github.com/thephpleague/container
-->
                <section>
                    <div class="aligncenter">
                        <h2><strong>Robôs</strong></h2>
                        <p>Usando o PHP para criar daemons</p>
                    </div>
                </section>
                <section>
                    <div class="wrap aligncenter">
                        <h3>É a melhor solução para o meu problema?</h3>
                        <p>Primeiro, considere se você está usando as melhores ferramentas para cada tipo de trabalho</p>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <div class="grid vertical-align">
                            <div class="column">
                                <h3>Gerenciador de robôs</h3>
                                <p class="text-intro">Para iniciar, terminar e acompanhar a execução</p>
                                <p>Ou você pode ter daemons "auto-executáveis" - por exemplo, diretamente via <em>cron</em></p>
                            </div>
                            <div class="column">
                                <pre><code class="language-php">class DaemonManager {
    protected $pool = [];

    public function start() {
        $this->pool = [];
        // Busque os robôs que devem ser executados de
        // um banco de dados, arquivo de configuração, etc
        foreach ($this->getDaemons() as $class) {
            $this->pool[] = $this->startDaemon($class);
        }

        $this->watch();
    }

    public function stop() {
        foreach ($this->pool as $daemon) {
            $this->stopDaemon($daemon);
        }
    }

    protected function getDaemons() { /* ... */ }

    protected function startDaemon($class) { /* ... */ }

    protected function stopDaemon(DaemonAbstract $daemon) { /* ... */}

    protected function watch() { /* ... */ }
}</code></pre>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <div class="grid vertical-align">
                            <div class="column">
                                <h3>pcntl</h3>
                                <p class="text-intro">Extensão <em>Process Control</em> com diversas funcionalidades</p>
                                <p>Manual do PHP: <a href="http://php.net/pcntl">php.net/pcntl</a></p>
                            </div>
                            <div class="column">
                                <pre><code class="language-php">pcntl_alarm(); // Set an alarm clock for delivery of a signal
pcntl_async_signals(); // Enable/disable asynchronous signal handling or return the old setting
pcntl_errno(); // Alias of pcntl_get_last_error
pcntl_exec(); // Executes specified program in current process space
pcntl_fork(); // Forks the currently running process
pcntl_get_last_error(); // Retrieve the error number set by the last pcntl function which failed
pcntl_getpriority(); // Get the priority of any process
pcntl_setpriority(); // Change the priority of any process
pcntl_signal_dispatch(); // Calls signal handlers for pending signals
pcntl_signal_get_handler(); // Get the current handler for specified signal
pcntl_signal(); // Installs a signal handler
pcntl_sigprocmask(); // Sets and retrieves blocked signals
pcntl_sigtimedwait(); // Waits for signals, with a timeout
pcntl_sigwaitinfo(); // Waits for signals
pcntl_strerror(); // Retrieve the system error message associated with the given errno
pcntl_wait(); // Waits on or returns the status of a forked child
pcntl_waitpid(); // Waits on or returns the status of a forked child
pcntl_wexitstatus(); // Returns the return code of a terminated child
pcntl_wifexited(); // Checks if status code represents a normal exit
pcntl_wifsignaled(); // Checks whether the status code represents a termination due to a signal
pcntl_wifstopped(); // Checks whether the child process is currently stopped
pcntl_wstopsig(); // Returns the signal which caused the child to stop
pcntl_wtermsig(); // Returns the signal which caused the child to terminate</code></pre>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <div class="grid vertical-align">
                            <div class="column">
                                <h4>Fluxo simples de execução</h4>
                                <p class="text-intro">Utilizando <code>pcntl_fork()</code></p>
                                <p>Para iniciar um processo (via <em>fork</em>)</p>
                            </div>
                            <div class="column">
                                <pre><code class="language-php">protected function startDaemon($class)
{
    $pid = pcntl_fork();
    if ($pid == -1) {
        throw new RuntimeException("Houve um erro no fork do robô {$class}");
    }

    if ($pid) {
        // Processo pai
        return $pid;
    }

    // Processo filho (robô)
    $daemon = new $class();
    $daemon->run();
    die();
}</code></pre>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <div class="grid vertical-align">
                            <div class="column">
                                <h4>Fluxo simples de execução</h4>
                                <p class="text-intro">Utilizando <code>pcntl_waitpid()</code></p>
                                <p>Para aguardar o término da execução</p>
                            </div>
                            <div class="column">
                                <pre><code class="language-php">protected function watch()
{
    $count = count($this->pool);
    while ($count > 0) {
        foreach ($this->pool as $index => $pid) {
            $return = pcntl_waitpid($pid, $status, WNOHANG);

            // Segundo o manual do pcntl_waitpid() [http://php.net/pcntl_waitpid]:
            // returns the process ID of the child which exited, -1 on error or zero
            // if WNOHANG was used and no child was available
            if ($return) {
                unset($this->pool[$index]);
                echo "Filho {$index} morreu..." . PHP_EOL;
                --$count;
            }
        }

        sleep(1);
    }
}</code></pre>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <div class="wrap aligncenter">
                        <h4>Demonstração</h4>
                        <p>A hora do palestrante passar vergonha quando nada funcionar</p>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <div class="grid vertical-align">
                            <div class="column">
                                <h3>pthreads</h3>
                                <p class="text-intro">Biblioteca que implementa o padrão <em>POSIX Threads</em></p>
                                <ul class="squared">
                                    <li>A V3 foi totalmente reescrita para uso no PHP 7.2</li>
                                    <li>Necessita do PHP compilado com ZTS (Zend Thread Safety)</li>
                                </ul>
                            </div>
                            <div class="column aligncenter">
                                <p>Classes disponíveis</p>
                                <ul class="flexblock">
                                    <li><code class="language-php">Threaded</code></li>
                                    <li><code class="language-php">Thread</code></li>
                                    <li><code class="language-php">Worker</code></li>
                                    <li><code class="language-php">Collectable</code></li>
                                    <li><code class="language-php">Modifiers</code></li>
                                    <li><code class="language-php">Pool</code></li>
                                    <li><code class="language-php">Mutex</code></li>
                                    <li><code class="language-php">Cond</code></li>
                                    <li><code class="language-php">Volatile</code></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <div class="grid vertical-align">
                            <div class="column">
                                <h3>Classe <code>Thread</code></h3>
                                <p class="text-intro">Ela deve implementar o método <code>run()</code></p>
                            </div>
                            <div class="column">
                                <pre><code class="language-php">class Task extends \Thread
{
    private $threadId;

    public function __construct($threadId)
    {
        $this->threadId = (int) $threadId;
    }

    public function run()
    {
        echo "Iniciando a thread {$this->threadId}" . PHP_EOL;
        sleep(rand(1, 5));
        echo "Finalizando a thread {$this->threadId}" . PHP_EOL;
    }
}</code></pre>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <div class="grid vertical-align">
                            <div class="column">
                                <h3>Classe <code>Worker</code></h3>
                                <p class="text-intro">Agrupa tarefas para serem executadas <em>sequencialmente</em></p>
                            </div>
                            <div class="column">
                                <pre><code class="language-php">$worker = new Worker();
$worker->start();

// Empilha 9 tarefas no worker
for ($i = 0; $i < 8; ++$i) {
    $worker->stack(new Task($i));
}

// Aguarda o término das tarefas
while ($worker->collect());

// Desliga o worker
$worker->shutdown();</code></pre>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <div class="grid vertical-align">
                            <div class="column">
                                <h3>Classe <code>Pool</code></h3>
                                <p class="text-intro">Agrupa <code>Worker</code>s para serem executados <em>concorrentemente</em></p>
                            </div>
                            <div class="column">
                                <pre><code class="language-php">// Cria 3 workers que serão executados simultaneamente
$pool = new Pool(3);

// Submete 9 tarefas para o pool
for ($i = 0; $i < 8; ++$i) {
    $pool->submit(new Task($i));
}

// Aguarda o término das tarefas
while ($pool->collect());

// Desliga todos os workers
$pool->shutdown();</code></pre>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <div class="grid vertical-align">
                            <div class="column">
                                <h4 class="no-margin-bottom">Pontos de atenção</h4>
                                <ul class="squared no-margin-top">
                                    <li>Tenha cuidado ao manusear memória compartilhada</li>
                                    <li>Nem toda tarefa ganha performance ao ser dividida em <em>threads</em></li>
                                    <li>Não se esqueça de aguardar as <em>threads</em> terminarem (<code>join</code>)</li>
                                    <li>Tenha cuidado ao manusear memória compartilhada (de novo)</li>
                                </ul>
                            </div>
                            <div class="column">
                                <h4 class="no-margin-bottom">Referências</h4>
                                <ul class="squared no-margin-top">
                                    <li><a href="https://blog.programster.org/ubuntu16-04-compile-php-7-2-with-pthreads">Tutorial para instalação</a></li>
                                    <li><a href="https://www.slideshare.net/jpauli/php-and-threads-zts">Slides sobre ZTS e threads no PHP</a> (@jpauli)</li>
                                    <li><a href="https://www.sitepoint.com/parallel-programming-pthreads-php-fundamentals/">Tutorial sobre pthreads</a> (SitePoint)</li>
                                    <li><a href="https://www.sitepoint.com/upgrading-pthreads-v2-v3-look/">Tutorial sobre pthreads v2 x v3</a> (SitePoint)</li>
                                    <li>Manual do PHP: <a href="http://php.net/pthreads">php.net/pthreads</a></li>
                                </ul>
                            </div>
                        </div>
                </section>
                <section>
                    <div class="aligncenter">
                        <h2><strong>Reutilização</strong></h2>
                        <p>Criando códigos que rodem em mais de um ambiente</p>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <h3>Boas práticas</h3>
                        <p class="text-intro">Deixe seu código limpo e organizado para facilitar o entendimento</p>
                        <ul class="squared">
                            <li>PHPCS</li>
                            <li>PHPMD</li>
                            <li>SOLID</li>
                            <li>Object Calisthenics</li>
                        </ul>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <h3>Configurações</h3>
                        <p class="text-intro">Como armazenar as configurações?</p>
                        <ul class="squared">
                            <li>12 Factor Apps: <a href="https://www.12factor.net/config">III. Config - Store config in the environment</a></li>
                        </ul>
                    </div>
                </section>
                <section>
                    <div class="wrap">
                        <h3>Injeção de dependências</h3>
                        <p class="text-intro">Como armazenar as configurações?</p>
                        <ul class="squared">
                            <li>
                                Interfaces
                                <ul>
                                    <li>Dependendo de Interfaces ao invés de classes Concretas ou até mesmo Abstratas</li>
                                </ul>
                            </li>
                            <li>
                                Containers
                                <ul>
                                    <li>
                                        PSR-11: Containers:
                                        <a href="https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-11-container.md">
                                            https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-11-container.md
                                        </a>
                                    </li>
                                    <li>
                                        The PHP League Container:
                                        <a href="https://github.com/thephpleague/container">
                                            https://github.com/thephpleague/container
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </section>
            </article>
            <!-- end article -->
        </main>
        <!-- end main -->

        <!-- A global footer

         <footer role="contentinfo">
          <div class="wrap">
            <p>An <a href="https://github.com/webslides/webslides">open source solution</a>, by <a href="https://twitter.com/webslides">@webslides</a>.</p>
          </div>
        </footer>  -->

        <!-- Required -->
        <script src="static/js/webslides.js"></script>
        <script>
            window.ws = new WebSlides({
                // changeOnClick: true,
                loop: false
            });
        </script>

        <script defer src="static/js/svg-icons.js"></script>
        <script defer src="static/js/prism.js"></script>
    </body>
</html>
